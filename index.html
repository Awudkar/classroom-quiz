<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Classroom Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding:20px; }
.hidden { display:none; }
.timer { font-size:20px; font-weight:bold; color:red; }
</style>
</head>
<body>

<div class="container">

<h2 class="text-center mb-4">Classroom Quiz System</h2>

<!-- Lecturer Panel -->
<div id="lecturerPanel" class="card p-3 mb-3">
<h4>Lecturer Upload Quiz</h4>
<input type="file" id="quizFile" class="form-control mb-2">
<label>Time (minutes)</label>
<input type="number" id="quizTime" class="form-control mb-2" value="10">
<button class="btn btn-primary" onclick="loadQuiz()">Activate Quiz</button>
</div>

<!-- Student Info -->
<div id="studentInfo" class="card p-3 mb-3 hidden">
<h4>Student Information</h4>
<input type="text" id="studentId" placeholder="Student ID" class="form-control mb-2" required>
<input type="text" id="studentName" placeholder="Full Name" class="form-control mb-2" required>
<input type="text" id="course" placeholder="Course" class="form-control mb-2" required>
<button class="btn btn-success" onclick="startQuiz()">Start Quiz</button>
</div>

<!-- Quiz Section -->
<div id="quizSection" class="hidden">
<div class="timer mb-3">Time Left: <span id="timeLeft"></span></div>
<form id="quizForm"></form>
<button class="btn btn-success mt-3" onclick="submitQuiz()">Submit Quiz</button>
</div>

<!-- Result Section -->
<div id="resultSection" class="hidden"></div>

<button class="btn btn-secondary mt-3 hidden" id="downloadBtn" onclick="downloadCSV()">Download Results CSV</button>

</div>

<script>
let quizData = [];
let timer;
let timeRemaining;
let submissions = [];

function loadQuiz() {
    const file = document.getElementById("quizFile").files[0];
    if (!file) return alert("Upload quiz file");

    const reader = new FileReader();
    reader.onload = function(e) {
        quizData = parseQuiz(e.target.result);
        quizData = shuffleArray(quizData);
        document.getElementById("studentInfo").classList.remove("hidden");
        document.getElementById("lecturerPanel").classList.add("hidden");
    };
    reader.readAsText(file);
}

function parseQuiz(text) {
    let questions = [];
    let blocks = text.split("\n\n");

    blocks.forEach(block => {
        let lines = block.split("\n");
        let q = { question: lines[0], options: [], correct: "" };

        lines.slice(1).forEach(line => {
            if (line.includes("*")) {
                let clean = line.replace("*","").trim();
                q.correct = clean;
                q.options.push(clean);
            } else {
                q.options.push(line.trim());
            }
        });

        q.options = shuffleArray(q.options);
        questions.push(q);
    });

    return questions;
}

function startQuiz() {
    if (!studentId.value || !studentName.value || !course.value)
        return alert("Fill all fields");

    document.getElementById("studentInfo").classList.add("hidden");
    document.getElementById("quizSection").classList.remove("hidden");

    renderQuiz();

    timeRemaining = document.getElementById("quizTime").value * 60;
    timer = setInterval(updateTimer, 1000);
}

function renderQuiz() {
    const form = document.getElementById("quizForm");
    form.innerHTML = "";

    quizData.forEach((q, index) => {
        let html = `<div class="card p-3 mb-2">
        <strong>${index+1}. ${q.question}</strong><br>`;

        q.options.forEach((opt, i) => {
            let letter = String.fromCharCode(97 + i);
            html += `
            <div>
            <input type="radio" name="q${index}" value="${opt}"> 
            ${letter}. ${opt}
            </div>`;
        });

        html += `</div>`;
        form.innerHTML += html;
    });
}

function updateTimer() {
    timeRemaining--;
    document.getElementById("timeLeft").innerText =
        Math.floor(timeRemaining/60) + ":" + (timeRemaining%60).toString().padStart(2,"0");

    if (timeRemaining <= 0) {
        clearInterval(timer);
        submitQuiz();
    }
}

function submitQuiz() {
    clearInterval(timer);

    let score = 0;
    let answersHTML = "";

    quizData.forEach((q, index) => {
        let selected = document.querySelector(`input[name="q${index}"]:checked`);
        let answer = selected ? selected.value : "Not Answered";

        if (answer === q.correct) score++;

        answersHTML += `
        <div class="card p-2 mb-2">
        <strong>${index+1}. ${q.question}</strong><br>
        Your Answer: ${answer}<br>
        Correct: ${q.correct}
        </div>`;
    });

    let percentage = ((score/quizData.length)*100).toFixed(2);

    submissions.push({
        id: studentId.value,
        name: studentName.value,
        course: course.value,
        score: score,
        total: quizData.length,
        percentage: percentage
    });

    document.getElementById("quizSection").classList.add("hidden");
    document.getElementById("resultSection").classList.remove("hidden");
    document.getElementById("downloadBtn").classList.remove("hidden");

    resultSection.innerHTML = `
    <div class="alert alert-info">
    <h4>Score: ${score}/${quizData.length}</h4>
    <h5>Percentage: ${percentage}%</h5>
    </div>` + answersHTML;
}

function downloadCSV() {
    let csv = "StudentID,Name,Course,Score,Total,Percentage\n";
    submissions.forEach(s => {
        csv += `${s.id},${s.name},${s.course},${s.score},${s.total},${s.percentage}%\n`;
    });

    let blob = new Blob([csv], {type:"text/csv"});
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "quiz_results.csv";
    link.click();
}

function shuffleArray(array) {
    return array.sort(() => Math.random() - 0.5);
}
</script>

</body>
</html>
