<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Classroom Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding:20px; }
.hidden { display:none; }
.timer { font-size:20px; font-weight:bold; color:red; }
</style>
</head>
<body>

<div class="container">

<h2 class="text-center mb-4">Classroom Quiz System</h2>

<!-- Lecturer Panel -->
<div id="lecturerPanel" class="card p-3 mb-3">
<h4>Lecturer Upload Quiz</h4>
<input type="file" id="quizFile" class="form-control mb-2">
<label>Time (minutes)</label>
<input type="number" id="quizTime" class="form-control mb-2" value="10">
<button class="btn btn-primary" onclick="loadQuiz()">Activate Quiz</button>
</div>

<!-- Student Info -->
<div id="studentInfo" class="card p-3 mb-3 hidden">
<h4>Student Information</h4>
<input type="text" id="studentId" placeholder="Student ID" class="form-control mb-2" required>
<input type="text" id="studentName" placeholder="Full Name" class="form-control mb-2" required>
<input type="text" id="course" placeholder="Course" class="form-control mb-2" required>
<button class="btn btn-success" onclick="startQuiz()">Start Quiz</button>
</div>

<!-- Quiz Section -->
<div id="quizSection" class="hidden">
<div class="timer mb-3">Time Left: <span id="timeLeft"></span></div>
<form id="quizForm"></form>
<button class="btn btn-success mt-3" onclick="submitQuiz()">Submit Quiz</button>
</div>

<!-- Result Section -->
<div id="resultSection" class="hidden"></div>

<button class="btn btn-secondary mt-3 hidden" id="downloadBtn" onclick="downloadCSV()">Download Results CSV</button>

</div>

<script>
let quizData = [];
let timer;
let timeRemaining;
let submissions = [];

function loadQuiz() {
    const file = document.getElementById("quizFile").files[0];
    if (!file) return alert("Upload quiz file");

    const reader = new FileReader();
    reader.onload = function(e) {
        quizData = parseQuiz(e.target.result);
        quizData = shuffleArray(quizData);
        document.getElementById("studentInfo").classList.remove("hidden");
        document.getElementById("lecturerPanel").classList.add("hidden");
    };
    reader.readAsText(file);
}

function parseQuiz(text) {
    const blocks = text.trim().split(/\n\s*\n/);
    const questions = [];

    blocks.forEach(block => {
        const lines = block
            .split("\n")
            .map(l => l.trim())
            .filter(l => l !== "");

        if (lines.length === 5) {
            const questionText = lines[0].replace(/^Q\d+\.\s*/, "");

            let options = [];
            let correctAnswerText = "";

            lines.slice(1).forEach(line => {
                if (line.includes("*")) {
                    correctAnswerText = line.replace("*", "").trim();
                    options.push(correctAnswerText);
                } else {
                    options.push(line.trim());
                }
            });

            // Randomize options
            options = shuffleArray(options);

            // Find new correct index after shuffle
            const correctIndex = options.indexOf(correctAnswerText);

            questions.push({
                question: questionText,
                options: options,
                answer: correctIndex
            });
        }
    });

    return shuffleArray(questions); // Randomize question order
}



function startQuiz() {
    if (!studentId.value || !studentName.value || !course.value)
        return alert("Fill all fields");

    document.getElementById("studentInfo").classList.add("hidden");
    document.getElementById("quizSection").classList.remove("hidden");

    renderQuiz();

    timeRemaining = document.getElementById("quizTime").value * 60;
    timer = setInterval(updateTimer, 1000);
}

function renderQuiz() {
    const form = document.getElementById("quizForm");
    form.innerHTML = "";

    quizData.forEach((q, index) => {
        let html = `<div class="card p-3 mb-2">
        <strong>${index+1}. ${q.question}</strong><br>`;

        q.options.forEach((opt, i) => {
            let letter = String.fromCharCode(97 + i);
            html += `
            <div>
            <input type="radio" name="q${index}" value="${opt}"> 
            ${letter}. ${opt}
            </div>`;
        });

        html += `</div>`;
        form.innerHTML += html;
    });
}

function updateTimer() {
    timeRemaining--;
    document.getElementById("timeLeft").innerText =
        Math.floor(timeRemaining/60) + ":" + (timeRemaining%60).toString().padStart(2,"0");

    if (timeRemaining <= 0) {
        clearInterval(timer);
        submitQuiz();
    }
}

function submitQuiz() {
    let score = 0;
    let resultHTML = "";

    questions.forEach((q, index) => {
        const selected = document.querySelector(
            `input[name="question${index}"]:checked`
        );

        const selectedValue = selected ? parseInt(selected.value) : null;

        const correctAnswerText = q.options[q.answer];

        resultHTML += `<div style="margin-bottom:15px;">`;
        resultHTML += `<strong>${index + 1}. ${q.question}</strong><br>`;

        if (selectedValue !== null) {
            const userAnswerText = q.options[selectedValue];

            if (selectedValue === q.answer) {
                score++;
            }

            resultHTML += `Your Answer: ${userAnswerText}<br>`;
            resultHTML += `Correct: ${correctAnswerText}<br>`;
        } else {
            resultHTML += `You did not answer this question.<br>`;
            resultHTML += `Correct: ${correctAnswerText}<br>`;
        }

        resultHTML += `</div>`;
    });

    document.getElementById("result").innerHTML =
        `<h4>Your Score: ${score} / ${questions.length}</h4>` + resultHTML;

    // Disable further changes
    document.querySelectorAll("input[type=radio]").forEach(r => r.disabled = true);
}

function downloadCSV() {
    let csv = "StudentID,Name,Course,Score,Total,Percentage\n";
    submissions.forEach(s => {
        csv += `${s.id},${s.name},${s.course},${s.score},${s.total},${s.percentage}%\n`;
    });

    let blob = new Blob([csv], {type:"text/csv"});
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "quiz_results.csv";
    link.click();
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

</script>

</body>
</html>





