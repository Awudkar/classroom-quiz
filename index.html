<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mock Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding:20px; }
.hidden { display:none; }
.timer { font-size:20px; font-weight:bold; color:red; }
</style>
</head>
<body>
<div class="container">

<h2 class="text-center mb-4">Mock Quiz -- Designed By Dr. Awudu Karim</h2>

<!-- Load Quiz Button -->
<div id="lecturerPanel" class="card p-3 mb-3">
<h4>Load Quiz</h4>
<button type="button" class="btn btn-primary" onclick="loadQuiz()">Load Quiz</button>
</div>

<!-- Student Info -->
<div id="studentInfo" class="card p-3 mb-3 hidden">
<h4>Student Information</h4>
<input type="text" id="studentId" placeholder="Student ID" class="form-control mb-2" required>
<input type="text" id="studentName" placeholder="Full Name" class="form-control mb-2" required>
<input type="text" id="course" placeholder="Course" class="form-control mb-2" required>
<label>Time (minutes)</label>
<input type="number" id="quizTime" class="form-control mb-2" value="10">
<button type="button" class="btn btn-success" onclick="startQuiz()">Start Quiz</button>
</div>

<!-- Quiz Section -->
<div id="quizSection" class="hidden">
<div class="timer mb-3">Time Left: <span id="timeLeft"></span></div>
<div id="quizForm"></div>
<button type="button" class="btn btn-success mt-3" onclick="submitQuiz(
  document.getElementById('studentId').value,
  document.getElementById('studentName').value,
  document.getElementById('course').value
)">Submit Quiz</button>
</div>

<!-- Result Section -->
<div id="resultSection" class="hidden"></div>

<button type="button" class="btn btn-secondary mt-3 hidden" id="downloadBtn" onclick="downloadCSV()">Download Results CSV</button>

</div>

<script>
let questions = [];
let timer;
let timeRemaining;
let submissions = [];

// ------------------ Load Quiz from quiz.txt ------------------
function loadQuiz() {
    fetch('quiz.txt')
    .then(response => response.text())
    .then(data => {
        questions = parseQuiz(data);
        document.getElementById("studentInfo").classList.remove("hidden");
        document.getElementById("lecturerPanel").classList.add("hidden");
    })
    .catch(err => alert("Could not load quiz: " + err));
}

// ------------------ Parse Quiz ------------------
function parseQuiz(text) {
    const blocks = text.trim().split(/\n\s*\n/);
    const qs = [];

    blocks.forEach(block => {
        const lines = block.split("\n").map(l => l.trim()).filter(l => l !== "");
        if (lines.length !== 5) return; // 1 question + 4 options

        const questionText = lines[0].replace(/^Q\d+\.\s*/, "");
        let opts = [];
        let correctText = "";

        lines.slice(1).forEach(line => {
            if (line.includes("*")) {
                correctText = line.replace("*", "").trim();
                opts.push(correctText);
            } else {
                opts.push(line.trim());
            }
        });

        opts = shuffleArray(opts);
        const correctIndex = opts.indexOf(correctText);

        qs.push({ question: questionText, options: opts, answer: correctIndex });
    });

    return shuffleArray(qs);
}

// ------------------ Start Quiz ------------------
function startQuiz() {
    const studentId = document.getElementById("studentId").value;
    const studentName = document.getElementById("studentName").value;
    const course = document.getElementById("course").value;

    if (!studentId || !studentName || !course) return alert("Fill all fields");

    document.getElementById("studentInfo").classList.add("hidden");
    document.getElementById("quizSection").classList.remove("hidden");
    document.getElementById("resultSection").classList.add("hidden");

    renderQuiz();

    timeRemaining = parseInt(document.getElementById("quizTime").value) * 60;
    document.getElementById("timeLeft").innerText =
        `${Math.floor(timeRemaining/60)}:${(timeRemaining%60).toString().padStart(2,'0')}`;

    timer = setInterval(() => {
        timeRemaining--;
        document.getElementById("timeLeft").innerText =
            `${Math.floor(timeRemaining/60)}:${(timeRemaining%60).toString().padStart(2,'0')}`;
        if (timeRemaining <= 0) {
            clearInterval(timer);
            submitQuiz(studentId, studentName, course);
        }
    }, 1000);
}

// ------------------ Render Quiz ------------------
function renderQuiz() {
    const container = document.getElementById("quizForm");
    container.innerHTML = "";

    questions.forEach((q, i) => {
        let html = `<div class="card p-3 mb-2"><strong>${i+1}. ${q.question}</strong><br>`;
        q.options.forEach((opt, j) => {
            const letter = String.fromCharCode(97 + j);
            html += `<div>
<input type="radio" name="question${i}" value="${j}"> ${letter}. ${opt}
</div>`;
        });
        html += `</div>`;
        container.innerHTML += html;
    });
}

// ------------------ Submit Quiz ------------------
function submitQuiz(studentId, studentName, course) {
    clearInterval(timer);

    let score = 0;
    let resultHTML = "";

    questions.forEach((q, i) => {
        const selected = document.querySelector(`input[name="question${i}"]:checked`);
        const selectedIndex = selected ? parseInt(selected.value) : null;
        const correctAnswer = q.options[q.answer];
        const userAnswer = selectedIndex !== null ? q.options[selectedIndex] : "Not Answered";

        if (selectedIndex === q.answer) score++;

        resultHTML += `<div class="card p-2 mb-2">
<strong>${i+1}. ${q.question}</strong><br>
Your Answer: ${userAnswer}<br>
Correct: ${correctAnswer}
</div>`;
    });

    document.getElementById("resultSection").classList.remove("hidden");
    document.getElementById("quizSection").classList.add("hidden");
    document.getElementById("resultSection").innerHTML = `<h4>Score: ${score} / ${questions.length}</h4>` + resultHTML;

    const percentage = ((score / questions.length) * 100).toFixed(2);
    submissions.push({ id: studentId, name: studentName, course: course, score, total: questions.length, percentage });
    document.getElementById("downloadBtn").classList.remove("hidden");

    document.querySelectorAll("input[type=radio]").forEach(r => r.disabled = true);
}

// ------------------ Download CSV ------------------
function downloadCSV() {
    let csv = "StudentID,Name,Course,Score,Total,Percentage\n";
    submissions.forEach(s => {
        csv += `${s.id},${s.name},${s.course},${s.score},${s.total},${s.percentage}%\n`;
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "quiz_results.csv";
    link.click();
}

// ------------------ Shuffle Array ------------------
function shuffleArray(arr) {
    for (let i = arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}
</script>
</body>
</html>

