let questions = [];  // Use only this variable everywhere
let timer;
let timeRemaining;
let submissions = [];

function loadQuiz() {
    const file = document.getElementById("quizFile").files[0];
    if (!file) return alert("Upload quiz file");

    const reader = new FileReader();
    reader.onload = function(e) {
        questions = parseQuiz(e.target.result);
        document.getElementById("studentInfo").classList.remove("hidden");
        document.getElementById("lecturerPanel").classList.add("hidden");
    };
    reader.readAsText(file);
}

function parseQuiz(text) {
    const blocks = text.trim().split(/\n\s*\n/);
    const qs = [];

    blocks.forEach(block => {
        const lines = block.split("\n").map(l => l.trim()).filter(l => l !== "");
        if (lines.length !== 5) return;  // 1 question + 4 options

        const questionText = lines[0].replace(/^Q\d+\.\s*/, "");
        let opts = [];
        let correctText = "";

        lines.slice(1).forEach(line => {
            if (line.includes("*")) {
                correctText = line.replace("*", "").trim();
                opts.push(correctText);
            } else {
                opts.push(line.trim());
            }
        });

        opts = shuffleArray(opts);
        const correctIndex = opts.indexOf(correctText);

        qs.push({ question: questionText, options: opts, answer: correctIndex });
    });

    return shuffleArray(qs);
}

function startQuiz() {
    const studentId = document.getElementById("studentId").value;
    const studentName = document.getElementById("studentName").value;
    const course = document.getElementById("course").value;

    if (!studentId || !studentName || !course) return alert("Fill all fields");

    document.getElementById("studentInfo").classList.add("hidden");
    document.getElementById("quizSection").classList.remove("hidden");
    document.getElementById("resultSection").classList.add("hidden");

    renderQuiz();

    timeRemaining = parseInt(document.getElementById("quizTime").value) * 60;
    document.getElementById("timeLeft").innerText = `${Math.floor(timeRemaining/60)}:${(timeRemaining%60).toString().padStart(2,'0')}`;

    timer = setInterval(() => {
        timeRemaining--;
        document.getElementById("timeLeft").innerText = `${Math.floor(timeRemaining/60)}:${(timeRemaining%60).toString().padStart(2,'0')}`;
        if (timeRemaining <= 0) {
            clearInterval(timer);
            submitQuiz(studentId, studentName, course);
        }
    }, 1000);
}

function renderQuiz() {
    const container = document.getElementById("quizForm");
    container.innerHTML = "";

    questions.forEach((q, i) => {
        let html = `<div class="card p-3 mb-2"><strong>${i+1}. ${q.question}</strong><br>`;
        q.options.forEach((opt, j) => {
            const letter = String.fromCharCode(97 + j); // a,b,c,d
            html += `<div>
                <input type="radio" name="question${i}" value="${j}"> ${letter}. ${opt}
            </div>`;
        });
        html += `</div>`;
        container.innerHTML += html;
    });
}

function renderQuiz() {
    const container = document.getElementById("quizForm");
    container.innerHTML = ""; // clear previous content

    questions.forEach((q, i) => {
        let html = `<div class="card p-3 mb-2">
<strong>${i+1}. ${q.question}</strong><br>`;

        q.options.forEach((opt, j) => {
            const letter = String.fromCharCode(97 + j); // a,b,c,d
            html += `
<div>
  <input type="radio" name="question${i}" value="${j}"> ${letter}. ${opt}
</div>`;
        });

        html += `</div>`;
        container.innerHTML += html;
    });
}


function downloadCSV() {
    let csv = "StudentID,Name,Course,Score,Total,Percentage\n";
    submissions.forEach(s => {
        csv += `${s.id},${s.name},${s.course},${s.score},${s.total},${s.percentage}%\n`;
    });

    const blob = new Blob([csv], {type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "quiz_results.csv";
    link.click();
}

function shuffleArray(arr) {
    for (let i = arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

