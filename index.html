<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mock Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding:20px; }
.hidden { display:none; }
.timer { font-size:20px; font-weight:bold; color:red; }
button { width: 100%; margin-top: 10px; }
</style>
</head>
<body>

<div class="container">

<h2 class="text-center mb-4">--Mock Quiz Designed by Dr. Awudu Karim for Self-Practice--</h2>

<!-- ---------------- Lecturer Panel ---------------- -->
<div id="lecturerPanel" class="card p-3 mb-3">
  <!-- <h4>Lecturer: Load Quiz</h4> -->
  <button type="button" class="btn btn-primary" onclick="loadQuiz()">Load Quiz</button>
</div>

<!-- ---------------- Student Info Panel ---------------- -->
<div id="studentInfo" class="card p-3 mb-3 hidden">
  <h4>Student Information</h4>
  <input type="text" id="studentId" placeholder="Student ID" class="form-control mb-2" required>
  <input type="text" id="studentName" placeholder="Full Name" class="form-control mb-2" required>
  <input type="text" id="courseInput" placeholder="Course" class="form-control mb-2" required>
  <button type="button" class="btn btn-success" onclick="startQuiz()">Start Quiz</button>
</div>

<!-- ---------------- Quiz Section ---------------- -->
<div id="quizSection" class="hidden">
  <div class="timer mb-3">Time Left: <span id="timeLeft"></span></div>
  <div id="quizForm"></div>
</div>

<!-- ---------------- Result Section ---------------- -->
<div id="resultSection" class="hidden"></div>

<button type="button" class="btn btn-secondary mt-3 hidden" id="downloadBtn" onclick="downloadCSV()">Download Results CSV</button>

</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let score = 0;
let timer;
let timeRemaining = 20; // 20 seconds per question
let quizLocked = false;
let submissions = [];

// ---------------- Load Quiz ----------------
function loadQuiz() {
    fetch('quiz.txt')
    .then(response => response.text())
    .then(data => {
        questions = parseQuiz(data);
        document.getElementById("studentInfo").classList.remove("hidden");
        document.getElementById("lecturerPanel").classList.add("hidden");
    })
    .catch(err => alert("Could not load quiz file"));
}

// ---------------- Parse Quiz ----------------
function parseQuiz(text) {
    const blocks = text.trim().split(/\n\s*\n/);
    let qs = [];
    blocks.forEach(block => {
        const lines = block.split("\n").map(l => l.trim()).filter(l => l !== "");
        if (lines.length !== 5) return; // 1 question + 4 options
        const questionText = lines[0].replace(/^Q\d+\.\s*/, "");
        let opts = [];
        let correctText = "";
        lines.slice(1).forEach(line => {
            if (line.includes("*")) {
                correctText = line.replace("*","").trim();
                opts.push(correctText);
            } else {
                opts.push(line.trim());
            }
        });
        opts = shuffleArray(opts);
        const correctIndex = opts.indexOf(correctText);
        qs.push({ question: questionText, options: opts, answer: correctIndex });
    });
    return shuffleArray(qs);
}

// ---------------- Start Quiz ----------------
function startQuiz() {
    enableSecurityMode();

    const id = document.getElementById("studentId").value;
    const name = document.getElementById("studentName").value;
    const course = document.getElementById("courseInput").value;

    if (!id || !name || !course) return alert("Fill all fields");

    document.getElementById("studentInfo").classList.add("hidden");
    document.getElementById("quizSection").classList.remove("hidden");

    currentQuestionIndex = 0;
    score = 0;

    showQuestion();
}

// ---------------- Show One Question ----------------
function showQuestion() {
    if (currentQuestionIndex >= questions.length) {
        endQuiz();
        return;
    }

    const q = questions[currentQuestionIndex];
    const container = document.getElementById("quizForm");
    container.innerHTML = `
        <div class="card p-3">
        <h5>Question ${currentQuestionIndex + 1} of ${questions.length}</h5>
        <strong>${q.question}</strong><br><br>
        ${q.options.map((opt, i) =>
            `<div>
             <input type="radio" name="option" value="${i}"> ${String.fromCharCode(97+i)}. ${opt}
             </div>`
        ).join("")}
        </div>
        <button class="btn btn-primary mt-3" onclick="nextQuestion()">Next</button>
    `;

    // Reset timer to 15s for each question
    timeRemaining = 20;
    updateTimerDisplay();
    clearInterval(timer);
    timer = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
            clearInterval(timer);
            nextQuestion();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining/60);
    const seconds = timeRemaining % 60;
    document.getElementById("timeLeft").innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;
}

// ---------------- Next Question ----------------
function nextQuestion() {
    const selected = document.querySelector('input[name="option"]:checked');
    const selectedIndex = selected ? parseInt(selected.value) : null;

    if (selectedIndex === questions[currentQuestionIndex].answer) score++;

    currentQuestionIndex++;
    showQuestion();
}

// ---------------- End Quiz ----------------
function endQuiz() {
    clearInterval(timer);

    const id = document.getElementById("studentId").value;
    const name = document.getElementById("studentName").value;
    const course = document.getElementById("courseInput").value;

    document.getElementById("quizSection").classList.add("hidden");
    document.getElementById("resultSection").classList.remove("hidden");

    document.getElementById("resultSection").innerHTML =
        `<h3>Quiz Completed</h3>
         <p><strong>Student ID:</strong> ${id}</p>
         <p><strong>Name:</strong> ${name}</p>
         <p><strong>Course:</strong> ${course}</p>
         <h4>Your Score: ${score} / ${questions.length}</h4>`;

    // Save submission
    const percentage = ((score / questions.length) * 100).toFixed(2);
    submissions.push({ id: id, name: name, course: course, score: score, total: questions.length, percentage: percentage });
    document.getElementById("downloadBtn").classList.remove("hidden");
}

// ---------------- Download CSV ----------------
function downloadCSV() {
    let csv = "StudentID,Name,Course,Score,Total,Percentage\n";
    submissions.forEach(s => {
        csv += `${s.id},${s.name},${s.course},${s.score},${s.total},${s.percentage}%\n`;
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "quiz_results.csv";
    link.click();
}

// ---------------- Security Mode ----------------
function enableSecurityMode() {
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("copy", e => e.preventDefault());
    document.addEventListener("cut", e => e.preventDefault());
    document.addEventListener("keydown", function(e) {
        if (e.ctrlKey && ["c","x","u","s"].includes(e.key)) e.preventDefault();
        if (e.key === "F12") e.preventDefault();
    });
}

// ---------------- Tab Switch Detection ----------------
document.addEventListener("visibilitychange", function() {
    if (document.hidden && !quizLocked) {
        quizLocked = true;
        clearInterval(timer);
        document.body.innerHTML =
            "<h2 style='color:red;text-align:center;margin-top:100px;'>Tab Switching Detected. Quiz Locked.</h2>";
    }
});

// ---------------- Shuffle ----------------
function shuffleArray(arr) {
    for (let i = arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

</script>
</body>
</html>




